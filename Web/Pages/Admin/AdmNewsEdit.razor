@page "/admin/news/edit/{newsId:int}"
@page "/admin/news/create"

@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IdentityAuthenticationStateProvider authStateProvider
@attribute [Authorize(Policy = Policy.News)]

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-16">
    @if (SendNews == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <EditForm Model="@SendNews" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />
            <MudCard Elevation="0">
                <MudCardContent>
                    <MudTextField Label="Title" @bind-Value="SendNews.Title" For="@(() => SendNews.Title)" Variant="Variant.Outlined" />
                    <MudTextField Label="Text" @bind-Value="SendNews.Text" For="@(() => SendNews.Text)" Variant="Variant.Outlined" />
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Button" Variant="Variant.Text" Color="Color.Default" StartIcon="@Icons.Material.Filled.Close" OnClick="Navigate" Class="ml-3">Cancel</MudButton>
                    @if (NewsId != null)
                    {<MudButton ButtonType="ButtonType.Button" StartIcon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Secondary" OnClick="RemoveNews" Class="ml-auto">Remove</MudButton>}
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mx-2">Save</MudButton>
                </MudCardActions>
            </MudCard>
        </EditForm>}
</MudContainer>

@code {
    [Parameter]
    public int? NewsId { get; set; }
    private NewsEditDTO SendNews;

    protected override async Task OnInitializedAsync()
    {
        if (NewsId == null)
        {
            SendNews = new NewsEditDTO() { UserId = await authStateProvider.GetUserId() };
        }
        else
        {
            SendNews = await Http.GetFromJsonAsync<NewsEditDTO>($"News/{NewsId}");
        }
    }

    private async Task OnValidSubmit(EditContext context)
    {
        if (NewsId == null)
        {
            SendNews.Date = DateTime.Now;
            await Http.PostAsJsonAsync<NewsEditDTO>("News", SendNews);
        }
        else
        {
            await Http.PutAsJsonAsync<NewsEditDTO>("News", SendNews);
        }
        Navigate();
    }

    private async Task RemoveNews()
    {
        await Http.DeleteAsync($"News/{NewsId}");
        Navigate();
    }

    private void Navigate()
    {
        NavigationManager.NavigateTo($"/admin/news");
    }
}
