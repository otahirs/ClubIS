@page "/event/{eventId:int}"
@using System.Text.Json
@inject HttpClient Http
@attribute [Authorize]
@inject IdentityAuthenticationStateProvider AuthState
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-16">
    @if (_e == null || _displayedEntries == null || _users == null || _sendEntry == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true"/>
    }
    else
    {
        <MudBreadcrumbs Items="_breadCrumbs"></MudBreadcrumbs>
        <EventHeader Event="_e"/>
        @if (_e.EventState != EventState.Canceled && !IsAfterDeadlines())
        {
            <EditForm Model="@_sendEntry" OnValidSubmit="OnValidSubmit">
                <DataAnnotationsValidator/>
                <MudCard Elevation="0">
                    <MudCardContent>
                        <MudGrid>
                            <MudItem md="6">
                                <MudAutocomplete Label="User" T="int" Value="_sendEntry.UserId" ValueChanged="UpdateData" SearchFunc="@Search" ToStringFunc="@(id => _users.Find(u => u.Id == id).Name)" Variant="Variant.Outlined" CoerceText="true"/>
                                <MudSelect Label="Class" Required="true" @bind-Value="@_sendEntry.Class" Variant="Variant.Outlined">
                                    @foreach (var c in _e.ClassOptions)
                                    {
                                        <MudSelectItem Value="@c.Name">@c.Name</MudSelectItem>
                                    }
                                </MudSelect>
                                @if (_e.TransportOption == ClubEventOption.Optional)
                                {
                                    <MudCheckBox T="bool" @bind-Checked="@_sendEntry.HasClubTransport" Label="Transport"/>
                                }

                                @if (_e.AccommodationOption == ClubEventOption.Optional)
                                {
                                    <MudCheckBox T="bool" @bind-Checked="@_sendEntry.HasClubAccommodation" Label="Accommodation"/>
                                }

                                <MudSelect T="int" Label="SI card number" Variant="Variant.Outlined" Value="SiCard" ValueChanged="SiChanged">
                                    @foreach (var card in GetSiCards(_sendEntry.UserId))
                                    {
                                        <MudSelectItem Value="@card.Number">@card.Number.ToString()</MudSelectItem>
                                    }
                                    <MudSelectItem Value="@Custom">Custom</MudSelectItem>
                                </MudSelect>
                                @if (SiCard == Custom)
                                {
                                    <MudTextField T="int?" @ref="@_customSiField" Label="Custom SI card number" For="@(() => _sendEntry.SiCardNumber)" Variant="Variant.Outlined"/>
                                }

                                <MudTextField Label="Note(intern)" @bind-Value="_sendEntry.NoteForClub" For="@(() => _sendEntry.NoteForClub)" Variant="Variant.Outlined"/>

                                <MudTextField Label="Note(organizer)" @bind-Value="_sendEntry.NoteForOrganisator" For="@(() => _sendEntry.NoteForOrganisator)" Variant="Variant.Outlined"/>
                            </MudItem>
                            <MudItem md="6">
                                @if (_e.EventStages.Count != 0)
                                {
                                    <MudCard Class="mt-1">
                                        <MudCardContent>
                                            <MudText Typo="Typo.h6">
                                                <b>Event Stages:</b>
                                            </MudText>
                                            @foreach (var s in _e.EventStages)
                                            {
                                                <MudCheckBox @bind-Checked="s.Selected">
                                                    @s.Date.ToString("dd.MM.yyyy"), <b>@s.Name</b>
                                                </MudCheckBox>
                                                <br>
                                            }
                                        </MudCardContent>
                                    </MudCard>
                                }
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                    <MudCardActions>
                        <MudGrid>
                            <MudItem md="6">
                                @if (_sendEntry.Id == 0 || _sendEntry.Status == EntryStatus.Removed)
                                {
                                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Save</MudButton>
                                }
                                else
                                {
                                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Save</MudButton>
                                    <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Delete" OnClick="RemoveEntry" Class="mx-2">Remove</MudButton>
                                }
                            </MudItem>
                        </MudGrid>
                    </MudCardActions>
                </MudCard>
            </EditForm>
        }
        <MudDivider Class="mt-4 mb-4"/>
        <MudText Typo="Typo.h5" GutterBottom="true">Entries</MudText>
        <MudTable Items="@_displayedEntries" Dense="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Class</MudTh>
                <MudTh>ComTram</MudTh>
                <MudTh>ComAcco</MudTh>
                <MudTh>SiNum</MudTh>
                <MudTh>Note(i)</MudTh>
                <MudTh>Note(org)</MudTh>
                <MudTh>Stages</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.Name</MudTd>
                <MudTd DataLabel="Class">@context.Class</MudTd>
                <MudTd DataLabel="ComTran">
                    @if (context.HasClubTransport)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check"/>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Close"/>
                    }
                </MudTd>
                <MudTd DataLabel="ComAcco">
                    @if (context.HasClubAccommodation)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Check"/>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Close"/>
                    }
                </MudTd>
                <MudTd DataLabel="SiNum">@context.SiCardNumber</MudTd>
                <MudTd DataLabel="Note(i)">@context.NoteForClub</MudTd>
                <MudTd DataLabel="Note(org)">@context.NoteForOrganisator</MudTd>
                <MudTd DataLabel="Stages">@GetStages(context.EnteredStages)</MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {

    [Parameter]
    public int EventId { get; set; }

    private int _userId;
    private MudTextField<int?> _customSiField;
    private int Custom { get; } = -1;
    private int SiCard { get; set; }

    private EventDTO _e;
    private List<EntryUserListDTO> _users;
    private List<EventEntryDTO> _displayedEntries;
    private List<EventEntryDTO> _allEntries;
    private EventEntryDTO _sendEntry;

    private readonly List<BreadcrumbItem> _breadCrumbs = new() {new BreadcrumbItem("Event Entries", "/events", icon: Icons.Material.Filled.DirectionsRun)};

    protected override async Task OnInitializedAsync()
    {
        _userId = await AuthState.GetUserId();
        _e = await Http.GetFromJsonAsync<EventDTO>($"Events/{EventId}");
        _users = await Http.GetFromJsonAsync<List<EntryUserListDTO>>($"Users/can-edit-entries/{_userId}");
        await LoadEntries();
        NewEntry(_userId);
        UpdateData(_userId);
        _breadCrumbs.Add(new BreadcrumbItem(_e.Name, null, true));
    }

    private void NewEntry(int id)
    {
        _sendEntry = new EventEntryDTO();
        _sendEntry.UserId = id;
        _sendEntry.EventId = EventId;
        _sendEntry.HasClubAccommodation = _e.AccommodationOption == ClubEventOption.ClubEnsured;
        _sendEntry.HasClubTransport = _e.TransportOption == ClubEventOption.ClubEnsured;
        _sendEntry.Status = EntryStatus.NotSent;
        _sendEntry.Class = _e.ClassOptions.ElementAt(0).Name;
        _sendEntry.EnteredStages = new HashSet<EventStageDTO>();
        _e.EventStages.ToList().ForEach(s => s.Selected = false);
    }

    private void UpdateData(int id)
    {
        _sendEntry = _allEntries.FirstOrDefault(e => e.UserId == id);
        if (_sendEntry == null)
        {
            NewEntry(id);
        }
        else
        {
            foreach (var stage in _e.EventStages)
            {
                stage.Selected = _sendEntry.EnteredStages.Any(s => s.Id == stage.Id);
            }
        }
        SiCard = GetSiCards(id).Count > 0 ? GetSiCards(id).FirstOrDefault(s => s.IsDefault)?.Number ?? Custom : Custom;
    }

    private ISet<SiCardDTO> GetSiCards(int id)
    {
        return _users.FirstOrDefault(c => c.Id == id)?.SiCards;
    }

    private async Task OnValidSubmit()
    {
        _sendEntry.SiCardNumber = SiCard == Custom ? _customSiField.Value.GetValueOrDefault() : SiCard;
        _sendEntry.EnteredStages.Clear();
        foreach (var stage in _e.EventStages)
        {
            if (stage.Selected)
            {
                _sendEntry.EnteredStages.Add(new EventStageDTO {Id = stage.Id});
            }
        }
        if (_sendEntry.Id == 0)
        {
            // add new
            await Http.PostAsJsonAsync("Entries", _sendEntry);
        }
        else
        {
            // edit
            _sendEntry.Status = EntryStatus.Changed;
            await Http.PutAsJsonAsync("Entries", _sendEntry);
        }
        await LoadEntries();
        UpdateData(_sendEntry.UserId);
        StateHasChanged();
    }

    private async void RemoveEntry()
    {
        if (_sendEntry.Status == EntryStatus.NotSent)
        {
            await Http.DeleteAsync($"Entries/{_sendEntry.Id}");
        }
        else
        {
            _sendEntry.Status = EntryStatus.Removed;
            await Http.PutAsJsonAsync("Entries", _sendEntry);
        }
        await LoadEntries();
        UpdateData(_sendEntry.UserId);
        StateHasChanged();
    }

    private async Task LoadEntries()
    {
        _allEntries = await Http.GetFromJsonAsync<List<EventEntryDTO>>($"Entries/event/{EventId}");
        _displayedEntries = _allEntries.Where(e => e.Status != EntryStatus.Removed).ToList();
        // ugly way to create a deep copy
        _displayedEntries = JsonSerializer.Deserialize<List<EventEntryDTO>>(JsonSerializer.Serialize(_displayedEntries));
    }

    private string GetStages(ISet<EventStageDTO> enteredStages)
    {
        return enteredStages.Count != 0 ? enteredStages.Select(s => s.Name).Aggregate((a, b) => a + ", " + b) : "";
    }

    private bool IsAfterDeadlines()
    {
        var maxDate = _e.Deadlines.Select(x => x.Deadline).Max();
        return DateTime.Compare(DateTime.Today, maxDate) >= 0;
    }

    private async Task SiChanged(int value)
    {
        SiCard = value;
        if (SiCard == Custom)
        {
            StateHasChanged(); // schedules component rerender
            await Task.Delay(1); // force rerender to be executed
            await _customSiField.FocusAsync();
        }
    }

    private async Task<IEnumerable<int>> Search(string searchValue)
    {
        var currUser = _users.First(u => u.Id == _sendEntry.UserId);
        if (string.IsNullOrEmpty(searchValue) || searchValue == currUser.Name)
            return _users.Select(u => u.Id); // show all
        return _users.Where(u => u.Name.Contains(searchValue, StringComparison.InvariantCultureIgnoreCase)).Select(u => u.Id); // filter
    }

}